---
# roles/common/tasks/main.yml
# Sets up users, SSH keys, NTP

- name: Wait for apt locks before installing packages
  ansible.builtin.shell: |
    timeout=300
    elapsed=0
    while [ $elapsed -lt $timeout ]; do
      # Check for running apt processes
      if pgrep -x apt-get > /dev/null || pgrep -x apt > /dev/null || pgrep -x dpkg > /dev/null; then
        echo "Apt processes still running, waiting... (${elapsed}s elapsed)"
        sleep 5
        elapsed=$((elapsed + 5))
        continue
      fi
      
      # Check for lock files
      if fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
         fuser /var/lib/dpkg/lock >/dev/null 2>&1; then
        echo "Lock files still held, waiting... (${elapsed}s elapsed)"
        sleep 5
        elapsed=$((elapsed + 5))
        continue
      fi
      
      # All clear
      echo "Apt locks released"
      exit 0
    done
    echo "Timeout waiting for apt locks"
    exit 1
  changed_when: false
  register: apt_lock_wait
  timeout: 360
  ignore_errors: yes

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 5
  delay: 10
  register: apt_cache_result
  until: apt_cache_result is succeeded

- name: Wait for apt locks before package installation
  ansible.builtin.shell: |
    timeout=300
    elapsed=0
    while [ $elapsed -lt $timeout ]; do
      if pgrep -x apt-get > /dev/null || pgrep -x apt > /dev/null || pgrep -x dpkg > /dev/null; then
        echo "Apt processes still running, waiting... (${elapsed}s elapsed)"
        sleep 5
        elapsed=$((elapsed + 5))
        continue
      fi
      if fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
         fuser /var/lib/dpkg/lock >/dev/null 2>&1; then
        echo "Lock files still held, waiting... (${elapsed}s elapsed)"
        sleep 5
        elapsed=$((elapsed + 5))
        continue
      fi
      echo "Apt locks released"
      exit 0
    done
    echo "Timeout waiting for apt locks"
    exit 1
  changed_when: false
  register: apt_lock_wait_install
  timeout: 360
  ignore_errors: yes

- name: Install common packages
  apt:
    name:
      - chrony
      - curl
      - wget
      - vim
      - htop
      - net-tools
    state: present
  retries: 10
  delay: 15
  register: apt_install_result
  until: apt_install_result is succeeded

- name: Ensure Chrony service is running
  ansible.builtin.systemd_service:
    name: chrony
    state: started
    enabled: yes

- name: Create sysadmin user
  ansible.builtin.user:
    name: sysadmin
    shell: /bin/bash
    groups: sudo
    append: yes
    create_home: yes
    state: present

- name: Ensure .ssh directory exists for sysadmin
  ansible.builtin.file:
    path: /home/sysadmin/.ssh
    state: directory
    owner: sysadmin
    group: sysadmin
    mode: '0700'

- name: Add SSH authorized key for sysadmin
  ansible.builtin.authorized_key:
    user: sysadmin
    state: present
    key: "{{ lookup('file', playbook_dir + '/privatekey.pub') }}"

- name: Allow sysadmin to sudo without password
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/sysadmin
    line: 'sysadmin ALL=(ALL) NOPASSWD:ALL'
    state: present
    create: yes
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Set timezone to Asia/Bangkok
  community.general.timezone:
    name: Asia/Bangkok
  ignore_errors: yes
