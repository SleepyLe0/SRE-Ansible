- name: Set up virtual machine on Proxmox
  hosts: localhost
  vars:
    vm_name: bookcnk
    vm_template: template
    proxmox_node: int531-05
    proxmox_api_host: 10.13.104.215
    proxmox_api_user: root@pam
    proxmox_api_password: int53105
    proxmox_storage: local-lvm
    vm_target_ip: 10.13.104.81
    ssh_key_path: "{{ playbook_dir }}/privatekey"
  tasks:
    - name: Check if SSH key pair exists
      ansible.builtin.stat:
        path: "{{ ssh_key_path }}"
      register: ssh_key_stat

    - name: Generate SSH key pair if not exists
      community.crypto.openssh_keypair:
        path: "{{ ssh_key_path }}"
        type: ed25519
        comment: "sysadmin@{{ vm_target_ip }}"
        mode: '0600'
      register: ssh_keypair
      when: not ssh_key_stat.stat.exists

    - name: Read public key
      ansible.builtin.slurp:
        src: "{{ ssh_key_path }}.pub"
      register: ssh_pubkey

    - name: Set SSH public key fact
      ansible.builtin.set_fact:
        vm_ssh_pubkey: "{{ ssh_pubkey.content | b64decode | trim }}"

    - name: Ping my hosts
      ansible.builtin.ping:

    - name: Get VM current state
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        name: "{{ vm_name }}"
        node: "{{ proxmox_node }}"
        state: current
      register: vm_info
      ignore_errors: true

    - name: Stop the VM if running
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        name: "{{ vm_name }}"
        node: "{{ proxmox_node }}"
        state: stopped
        force: true
      when: vm_info.vmid is defined and vm_info.status ==  'running'

    - name: Remove VM
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        name: "{{ vm_name }}"
        node: "{{ proxmox_node }}"
        state: absent
      when: vm_info.vmid is defined

    - name: Create VM
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        clone: "{{ vm_template }}"
        name: "{{ vm_name }}"
        node: "{{ proxmox_node }}"
        timeout: 100
        full: false
      register: new_vm

    - name: Update VM configuration
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ new_vm.vmid }}"
        ciuser: root
        cipassword: int53102
        sshkeys: "{{ vm_ssh_pubkey }}"
        nameservers: 8.8.8.8
        searchdomains: localdomain
        ipconfig:
          ipconfig0: 'ip={{ vm_target_ip }}/24,gw=10.13.104.254'
        update: yes

    - name: Ensure cloud-init drive exists on cloned VM
      ansible.builtin.command:
        cmd: "qm set {{ new_vm.vmid }} --ide2 local-lvm:cloudinit"
      delegate_to: "{{ proxmox_api_host }}"
      vars:
        ansible_user: root
        ansible_ssh_pass: int53105
      ignore_errors: yes
      register: cloudinit_drive
      changed_when: "'update' in cloudinit_drive.stdout"

    - name: Regenerate cloud-init configuration
      ansible.builtin.command:
        cmd: "qm cloudinit dump {{ new_vm.vmid }} user"
      delegate_to: "{{ proxmox_api_host }}"
      vars:
        ansible_user: root
        ansible_ssh_pass: int53105
      register: cloudinit_config
      ignore_errors: yes

    - name: Display cloud-init configuration
      ansible.builtin.debug:
        msg: "{{ cloudinit_config.stdout_lines }}"
      when: cloudinit_config.stdout_lines is defined

    - name: Wait a moment for configuration to apply
      ansible.builtin.pause:
        seconds: 10

    - name: Start VM
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        vmid: "{{ new_vm.vmid }}"
        node: "{{ proxmox_node }}"
        state: started

    - name: Display VM info
      ansible.builtin.debug:
        msg:
          - "VM ID: {{ new_vm.vmid }}"
          - "VM Name: {{ vm_name }}"
          - "Target IP: {{ vm_target_ip }}"
          - "Waiting for cloud-init to configure network..."

    - name: Wait for VM to be reachable via SSH
      ansible.builtin.wait_for:
        host: "{{ vm_target_ip }}"
        port: 22
        delay: 30
        timeout: 300
        sleep: 5

    - name: Wait for cloud-init to finish
      ansible.builtin.command: cloud-init status --wait
      delegate_to: "{{ vm_target_ip }}"
      vars:
        ansible_user: root
        ansible_ssh_private_key_file: "{{ ssh_key_path }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      changed_when: false
      register: cloud_init_result
      failed_when: cloud_init_result.rc not in [0, 2]

- name: Configure the new VM hostname
  hosts: 10.13.104.81
  gather_facts: yes
  become: yes
  vars:
    ansible_host: 10.13.104.81
    ansible_user: root
    ansible_ssh_private_key_file: "{{ playbook_dir }}/privatekey"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PreferredAuthentications=publickey -o ControlMaster=no'
  roles:
    - common
    - app
    - monitor
